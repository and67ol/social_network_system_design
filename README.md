# Social Network System Design

System Design социальной сети для [курса System Design](https://balun.courses/courses/system_design)

### Функциональные требования:

- публикация постов из путешествий с фотографиями, небольшим описанием и привязкой к конкретному месту путешествия;
- оценка и комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест;
- просмотр ленты других путешественников и ленты пользователя, основанной на подписках в обратном хронологическом
  порядке;

---

### Нефункциональные требования:

- DAU 10 000 000
- Сезонность
    - Новогодние праздники
    - Летние отпуска
- Платформы:
    - веб
    - мобильное приложение
- Доступность(99.99%)
- аудиторию стран СНГ
- Срок хранения данных: 10 лет
- Активность пользователей(в среднем в день)
    - создает 2 постов
    - просматривает 50 постов
    - ставит 20 реакций
    - оставляет 30 комментариев
    - подписывается на 10 человек

---

### Максимальные значения параметров системы

| Параметр                                                                    | Значение  |
|-----------------------------------------------------------------------------|-----------|
| Постов в сутки у пользователя                                               | 100       |
| Фотографий в посте                                                          | 5         |
| Размер фотографии                                                           | 1 МБ      |
| Количество символов в описании                                              | 1 000     |
| Максимальное количество подписчиков у пользователя                          | 5 000 000 |
| Количество постов у пользователя                                            | 1 000 000 |
| Максимальное количество комментариев на один пост                           | 100 000   |
| Максимальное количество комментариев на один пост в день                    | 5 000     |
| Максимальное количество реакций на один пост                                | 1 000 000 |
| Максимальное количество постов с привязкой к одному месту                   | 10 000    |
| Максимальное количество оценок, которое может поставить пользователь в день | 500       |
| Количество мест для путешествий                                             | 100 000   |
| Лента подгружается по (пагинация)                                           | 50 постов |

---

### Средний размер поста

5 фото × 1 МБ + 1 000 символов ≈ **5 МБ** (≈ 5 000 000 байт)

---

### Нагрузки

---

### Посты

| Показатель | Создание (медиа) | Создание (мета) | Просмотр (медиа) | Просмотр (мета) |
|------------|------------------|-----------------|------------------|-----------------|
| RPS        | 231              | 231             | 5 787            | 5 787           |
| Трафик     | ≈ 1.16 ГБ/с      | ≈ 0.46 МБ/с     | ≈ 6.65 ГБ/с      | ≈ 11.6 МБ/с     |

**Расчёт:**

- RPS
    - создание → `10 000 000 × 2 / 86 400 = 231`
    - просмотр → `10 000 000 × 50 / 86 400 = 5 787`
- трафик:
    - медиа создание → `231 × 5 000 000 = 1 155 000 000 байт/с ≈ 1.16 ГБ/с`
    - мета создание → `231 × 2 000 = 462 000 байт/с ≈ 0.46 МБ/с`
    - медиа просмотр → `5 787 × 1 150 000 = 6 655 050 000 байт/с ≈ 6.65 ГБ/с`
    - мета просмотр → `5 787 × 2 000 = 11 574 000 байт/с ≈ 11.6 МБ/с`

---

### Комментарии

| Показатель | Создание (мета) | Просмотр (мета) |
|------------|-----------------|-----------------|
| RPS        | 3 472           | 2 315           |
| Трафик     | ≈ 3.5 МБ/с      | ≈ 2.3 МБ/с      |

**Расчёт:**

- RPS
    - создание → `10 000 000 × 30 / 86 400 = 3 472`
    - просмотр → `10 000 000 × 20 / 86 400 = 2 315`
- трафик:
    - создание → `3 472 × 1 000 = 3 472 000 байт/с ≈ 3.5 МБ/с`
    - просмотр → `2 315 × 1 000 = 2 315 000 байт/с ≈ 2.3 МБ/с`

---

### Реакции

| Показатель | Создание (мета) | Просмотр (мета) |
|------------|-----------------|-----------------|
| RPS        | 2 315           | 2 315           |
| Трафик     | ≈ 18.5 КБ/с     | ≈ 18.5 КБ/с     |

**Расчёт:**

- RPS
    - создание → `10 000 000 × 20 / 86 400 = 2 315`
    - просмотр → `10 000 000 × 20 / 86 400 = 2 315`
- трафик:
    - создание → `2 315 × 8 = 18 520 байт/с ≈ 18.5 КБ/с`
    - просмотр → `2 315 × 8 = 18 520 байт/с ≈ 18.5 КБ/с`

---

### Подписки

| Показатель | Создание (мета) |
|------------|-----------------|
| RPS        | 1 157           |
| Трафик     | ≈ 0.46 МБ/с     |

**Расчёт:**

- RPS → `10 000 000 × 10 / 86 400 = 1 157`
- Трафик → `1 157 × 400 = 462 800 байт/с ≈ 0.46 МБ/с`

---

# Полный расчёт дисков на 1 год

- секунд в году - 31_536_000 (365 × 24 × 60 × 60)
- Считаем для трёх подсистем:
    - Посты (медиа/мета)
    - Комментарии (мета)
    - Реакции (мета)
- **Посты — медиа** (фото) хранятся во внешнем объектном хранилище (**S3/CDN**) и не участвуют в подборе локальных
  дисков.

> - **HDD**: `32 TB`, `100 МБ/с`, `100 IOPS`
> - **SSD (SATA)**: `100 TB`, `500 МБ/с`, `1 000 IOPS`
> - **NVMe**: `30 TB`, `3 GB/s`, `10 000 IOPS`

- Для емкости считаем только запись (создание).
- Для пропускной — чтение + запись.
- IOPS ≈ суммарный RPS (чтение + запись).

| Подсистема         | write_throughput | Read_Write_per_second    | RPS_total             |
|--------------------|------------------|--------------------------|-----------------------|
| Посты — медиа      | 1.16 GB/s        | 6.65 + 1.16 = 7.81 GB/s  | 5 787 + 231 =6 018    |
| Посты — мета       | 0.46 MB/s        | 11.6 + 0.46 = 12.06 MB/s | 6 018                 |
| Комментарии — мета | 3.5 MB/s         | 2.3 + 3.5 = 5.8 MB/s     | 2 315 + 3 472 = 5 787 |
| Реакции — мета     | 18.5 KB/s        | 18.5 + 18.5 = 37 KB/s    | 2 315 + 2 315 = 4 630 |

### Посты — медиа

write_throughput = 1.16 GB/s
Read_Write_per_second = трафик(медиа просмотр) + трафик(медиа создание) = 6.65 + 1.16 = 7.81 GB/s
RPS_total = RPS(просмотр) + RPS(создание) = 5 787 + 231 = 6 018

### Посты — мета

write_throughput = Трафик(Создание(мета)) = 0.46 МБ/с
Read_Write_per_second = Трафик(Просмотр(мета)) + Трафик(Создание(мета)) = 11.6 + 0.46 = 12.06 МБ/с
RPS_total = 6 018

### Комментарии — мета

write_throughput = трафик(Создание (мета)) = 3.5 МБ/с
Read_Write_per_second = трафик(Просмотр (мета)) + трафик(Создание (мета)) = 2.3 + 3.5 = 5.8 МБ/с
RPS_total = 2 315 + 3 472 = 5 787

### Реакции — мета

write_throughput = трафик(Создание (мета)) = 18.5 KB/s
Read_Write_per_second = трафик(Создание (мета)) + трафик(Просмотр (мета)) = 18.5 + 18.5 = 37 KB/s
RPS_total = 2_315 + 2_315 = 4_630

---

## Годовые объёмы (ёмкость)

| Подсистема         | Скорость записи (write_throughput) | Годовой объём, TB    |
|--------------------|------------------------------------|----------------------|
| Посты — медиа      | 1.16 GB/s                          | 36 581.76 TB(S3/CDN) |
| Посты — мета       | 0.46 MB/s                          | 14.50656 TB          |
| Комментарии — мета | 3.5 MB/s                           | 110.376 TB           |
| Реакции — мета     | 18.5 KB/s                          | 0.583416 TB          |
| **Итого**          | —                                  | 36 707.226 TB        |

### Посты — медиа

yearly_bytes = 1.16 GB/s × 31_536_000 = 36 581 760 000 000 000 B
yearly_TB = 36_581.76 TB

### Посты — мета

yearly_bytes = 0.46 МБ/с × 31_536_000 = 14_506_560_000_000 B
yearly_TB = 14.50656 TB

### Комментарии — мета

yearly_bytes = 3.5 МБ/с × 31_536_000 = 110_376_000_000_000 B
yearly_TB = 110.376 TB

### Реакции — мета

yearly_bytes = 18.5 KB/s × 31_536_000 = 583_416_000_000 B
yearly_TB = 0.583416 TB

### Сумма годовых объёмов

36_581.76 + 14.50656 + 110.376 + 0.583416 = 36_707.225976 TB ≈ 36_707.226 TB
       
---

# Подбор дисков (HDD vs SSD vs NVMe)

## 1) Посты — мета (14.50656 TB; 12.06 МБ/с; 6_018 IOPS)

| Тип дисков        | disks_cap (по ёмкости) | disks_bw (по пропускной) | IOPS   | Итого дисков |
|-------------------|------------------------|--------------------------|--------|--------------|
| HDD 32 TB         | 0.4533                 | 0.1206                   | 60.18  | 61           |
| SSD (SATA) 100 TB | 0.1451                 | 0.02412                  | 6.018  | 7            |
| NVMe 30 TB        | 0.4836                 | 0.00402                  | 0.6018 | 1            |

**HDD 32 TB**
disks_cap = 14.50656 / 32 = 0.4533…
disks_bw = 12.06 МБ/с / 100 МБ/с = 0.1206
disks_iops = 6_018 / 100 = 60.18
disks = 61

**SSD (SATA) 100 TB**
disks_cap = 14.50656 / 100 = 0.1450656
disks_bw = 12.06 МБ/с / 500 МБ/с = 0.02412
disks_iops = 6_018 / 1_000 = 6.018
disks = 7

**NVMe 30 TB**
disks_cap = 14.50656 / 30 = 0.483552
disks_bw = 12.06 МБ/с / 3 ГБ/с = 0.00402
disks_iops = 6_018 / 10_000 = 0.6018
disks = 1

**Выбор:** SSD (SATA) - 7 шт

## 2) Комментарии — мета (110.376 TB; 5.8 МБ/с; 5_787 IOPS)

| Тип дисков            | disks_cap (по ёмкости) | disks_bw (по пропускной) | IOPS   | Итого дисков |
|-----------------------|------------------------|--------------------------|--------|--------------|
| **HDD 32 TB**         | 3.44925                | 0.058                    | 57.87  | **58**       |
| **SSD (SATA) 100 TB** | 1.10376                | 0.0116                   | 5.787  | **6**        |
| **NVMe 30 TB**        | 3.6792                 | 0.00193                  | 0.5787 | **4**        |

**HDD 32 TB**
disks_cap = 110.376 / 32 = 3.44925
disks_bw = 5.8 МБ/с / 100 МБ/с = 0.058
disks_iops = 5_787 / 100 = 57.87
disks = 58

**SSD (SATA) 100 TB**
disks_cap = 110.376 / 100 = 1.10376
disks_bw = 5.8 МБ/с / 500 МБ/с = 0.0116
disks_iops = 5_787 / 1_000 = 5.787
disks = 6

**NVMe 30 TB**
disks_cap = 110.376 / 30 = 3.6792
disks_bw = 5.8 МБ/с / 3 ГБ/с = 0.001933…
disks_iops = 5_787 / 10_000= 0.5787
disks = 4

Выбор: SSD (SATA) - 6 шт.

## 4) Реакции — мета (0.583416 TB; 37 KB/s; 4_630 IOPS)

| Тип дисков            | disks_cap (по ёмкости) | disks_bw (по пропускной) | IOPS  | Итого дисков |
|-----------------------|------------------------|--------------------------|-------|--------------|
| **HDD 32 TB**         | 0.01823                | 0.00037                  | 46.3  | **47**       |
| **SSD (SATA) 100 TB** | 0.00583                | 0.000074                 | 4.63  | **5**        |
| **NVMe 30 TB**        | 0.01945                | 0.0000123                | 0.463 | **1**        |

**HDD 32 TB**
disks_cap = 0.583416 / 32 = 0.01823
disks_bw = 37 KB/s / 100 МБ/с = 0.00037
disks_iops = 4_630 / 100 = 46.3
disks = 47

**SSD (SATA) 100 TB**
disks_cap = 0.583416 / 100 = 0.00583416
disks_bw = 37 KB/s / 500 МБ/с = 7.4e-5
disks_iops = 4_630 / 1_000 = 4.63
disks = ceil(max(0.00583416, 7.4e-5, 4.63)) = 5

**NVMe 30 TB**
disks_cap = 0.583416 / 30 = 0.0194472
disks_bw = 37 KB/s / 3 ГБ/с = 1.2333e-5
disks_iops = 4_630 / 10_000 = 0.463
disks = 1

Выбор: SSD (SATA) — 5 шт.

---

# Сводная таблица

| Подсистема         | HDD 32 TB | SSD 100 TB | NVMe 30 TB | Итоговый выбор |
|--------------------|-----------|------------|------------|----------------|
| Посты — медиа      | -         | -          | -          | S3/CDN         |
| Посты — мета       | 61        | 7          | 1          | SSD (SATA) — 7 |
| Комментарии — мета | 58        | 6          | 4          | SSD (SATA) — 6 |
| Реакции — мета     | 47        | 5          | 1          | SSD (SATA) — 5 |

---

### Итог

- Локально требуется около 18 SSD (SATA)
- Медиа (36 ПБ/год) хранятся в S3/CDN